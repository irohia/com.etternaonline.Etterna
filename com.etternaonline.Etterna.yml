app-id: com.etternaonline.Etterna
runtime: org.freedesktop.Platform
runtime-version: '21.08'
sdk: org.freedesktop.Sdk
command: launcher
finish-args:
  - --filesystem=home
  - --share=network
  - --share=ipc
  - --socket=pulseaudio
  - --socket=x11
  - --device=dri
modules:
  - name: etterna
    buildsystem: simple
    build-commands:
      - ar -x libglu.deb
      - tar xvf data.tar.xz
      - mkdir -p /app/{bin,lib,firstrun/etterna-flatpak}
      - mkdir -p /app/share/{applications,icons/hicolor/scalable/apps,metainfo}
      - cp -rf com.etternaonline.Etterna.svg /app/share/icons/hicolor/scalable/apps
      - cp -rf com.etternaonline.Etterna.desktop /app/share/applications
      - cp -rf com.etternaonline.Etterna.metainfo.xml /app/share/metainfo
      - cp -rf Etterna /app/bin
      - cp -rf launcher /app/bin
      - cp -rf usr/lib/x86_64-linux-gnu/libGLU.so.1* /app/lib
      - mv /app/bin/Etterna/NoteSkins /app/firstrun/etterna-flatpak
      - mv /app/bin/Etterna/Themes /app/firstrun/etterna-flatpak
      - mv /app/bin/Etterna/Songs /app/firstrun/etterna-flatpak
      - mv /app/bin/Etterna/Assets /app/firstrun/etterna-flatpak
      - mkdir -p /app/firstrun/etterna-flatpak/{Save,Cache}
      - mkdir -p /app/bin/Etterna/{Logs,CrashData}
    sources:
      - type: script
        commands:
          - test ! -d $HOME/.etterna/state && mkdir -p $HOME/.etterna/state/{NoteSkins,Themes,Songs,Assets,Save,Cache} && cp -rf /app/firstrun/etterna-flatpak/* $HOME/.etterna/state
          - cp -rf $HOME/.etterna/game/{Save,Songs} $HOME/.etterna/state 2> /dev/null
          - rm -rf $HOME/.etterna/game 2> /dev/null
          - cp -rf /app/bin/Etterna $HOME/.etterna/game
          - cp -rf $HOME/.etterna/state/* $HOME/.etterna/game
          - exec $HOME/.etterna/game/Etterna
        dest-filename: launcher
      - type: archive
        url: "https://github.com/etternagame/etterna/releases/download/v0.72.1/Etterna-0.72.1-Linux.tar.gz"
        archive-type: tar-gzip
        sha256: "36db982c15eb4a8b5082ecccec7f92320c48e7a3c6da07721e635b3abe2185b5"
        dest-filename: Etterna
      - type: file
        url: "http://deb.debian.org/debian/pool/main/libg/libglu/libglu1-mesa_9.0.1-1_amd64.deb"
        sha256: "479736c235af0537c1af8df4befc32e638a4e979961fdb02f366501298c50526"
        dest-filename: libglu.deb
      - type: file
        url: "https://raw.githubusercontent.com/etternagame/etterna/master/Docs/images/etterna-logo-light.svg"
        sha256: "0c2d18f8a95809b023c19b160ac6f9cbd2e012a81b5d02b8ea9f35d88e1ae9a6"
        dest-filename: com.etternaonline.Etterna.svg
      - type: inline
        contents: "W0Rlc2t0b3AgRW50cnldCk5hbWU9RXR0ZXJuYQpJY29uPWNvbS5ldHRlcm5hb25saW5lLkV0dGVybmEKU3VtbWFyeT1BIHZlcnRpY2FsbHktc2Nyb2xsaW5nIHJoeXRobSBnYW1lIGRlc2lnbmVkIGZvciBrZXlib2FyZCBwbGF5CkV4ZWM9L2FwcC9iaW4vbGF1bmNoZXIKVHlwZT1BcHBsaWNhdGlvbgpUZXJtaW5hbD1mYWxzZQpLZXl3b3Jkcz1nYW1lO3JoeXRobTsKQ2F0ZWdvcmllcz1HYW1lO1gtQXJjYWRlOwo="
        base64: true
        dest-filename: com.etternaonline.Etterna.desktop
      - type: inline
        contents: "PD94bWwgdmVyc2lvbj0xLjAgZW5jb2Rpbmc9VVRGLTg/Pgo8Y29tcG9uZW50IHR5cGU9ZGVza3RvcC1hcHBsaWNhdGlvbj4KICA8aWQ+Y29tLmV0dGVybmFvbmxpbmUuRXR0ZXJuYTwvaWQ+CiAgCiAgPG5hbWU+RXR0ZXJuYTwvbmFtZT4KICA8c3VtbWFyeT5BIHZlcnRpY2FsbHktc2Nyb2xsaW5nIHJoeXRobSBnYW1lIGRlc2lnbmVkIGZvciBrZXlib2FyZCBwbGF5PC9zdW1tYXJ5PgogIAogIDxtZXRhZGF0YV9saWNlbnNlPk1JVDwvbWV0YWRhdGFfbGljZW5zZT4KICA8cHJvamVjdF9saWNlbnNlPk1JVDwvcHJvamVjdF9saWNlbnNlPgogIAogIDxkZXNjcmlwdGlvbj4KICAgIDxwPgogICAgICBFdHRlcm5hIGlzIGEgZm9yayBvZiB0aGUgcmh5dGhtIGdhbWUgU3RlcE1hbmlhIChhIGNsb25lIG9mIERhbmNlRGFuY2VSZXZvbHV0aW9uIGJ5IEtvbmFtaSB0aGF0IGhhcyBzaW5jZSBncm93biBpbnRvIGFuIGVudGlyZSByaHl0aG0gZ2FtZSBlbmdpbmUpIHRoYXQgaGFzIGJlZW4gcmViYWxhbmNlZCBhbmQgdHJpbW1lZCBkb3duIGZvciBrZXlib2FyZCBwbGF5ZXJzLgogICAgPC9wPgogIDwvZGVzY3JpcHRpb24+CiAgCiAgPGxhdW5jaGFibGUgdHlwZT1kZXNrdG9wLWlkPmNvbS5ldHRlcm5hb25saW5lLkV0dGVybmEuZGVza3RvcDwvbGF1bmNoYWJsZT4KICA8c2NyZWVuc2hvdHM+CiAgICA8c2NyZWVuc2hvdCB0eXBlPWRlZmF1bHQ+CiAgICAgIDxpbWFnZT5odHRwczovL2dpdGh1Yi5jb20vaXJvaGlhL2NvbS5ldHRlcm5hb25saW5lLkV0dGVybmEvcmF3L21haW4vZXR0ZXJuYS1tYWlubWVudS5wbmc8L2ltYWdlPgogICAgPC9zY3JlZW5zaG90PgogICAgPHNjcmVlbnNob3Q+CiAgICAgIDxpbWFnZT5odHRwczovL2dpdGh1Yi5jb20vaXJvaGlhL2NvbS5ldHRlcm5hb25saW5lLkV0dGVybmEvcmF3L21haW4vZXR0ZXJuYS1maXJzdHJ1bi5wbmc8L2ltYWdlPgogICAgPC9zY3JlZW5zaG90PgogICAgPHNjcmVlbnNob3Q+CiAgICAgIDxpbWFnZT5odHRwczovL2dpdGh1Yi5jb20vaXJvaGlhL2NvbS5ldHRlcm5hb25saW5lLkV0dGVybmEvcmF3L21haW4vZXR0ZXJuYS1zb25nc2VsZWN0LnBuZzwvaW1hZ2U+CiAgICA8L3NjcmVlbnNob3Q+CiAgPC9zY3JlZW5zaG90cz4KPC9jb21wb25lbnQ+Cg=="
        base64: true
        dest-filename: com.etternaonline.Etterna.metainfo.xml
